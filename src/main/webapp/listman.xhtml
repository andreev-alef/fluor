<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:cc="http://java.sun.com/jsf/composite/components">
<h:head>
  <title>Флюорокартотека</title>
  <h:outputScript library="js" name="locale.js" />  
  <f:metadata>
    <f:viewAction action="#{listmanBean.searchOrFilter()}" />
  </f:metadata>
</h:head>

<h:body>
  <h:outputStylesheet library="css" name="reset.css"/>
  <h:outputStylesheet library="css" name="fl-custom.css"/>
  
  <h:outputText value="&lt;!--[if lte IE 8]&gt;&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;/fluor/javax.faces.resource/ie8.css.xhtml?ln=css&quot;/&gt;&lt;![endif]--&gt;" escape="false" />
 
  <h:form id="frmList" class="form-wrap">
  <p:outputPanel class="wrap">
    
                  <div class="header">
		  <div class="custom-tab">Поиск пациента</div>
                  <div class="user-panel"><ui:include src="/WEB-INF/templates/userpanel.xhtml" /></div>
		  <p:outputPanel class="search-panel">		    
			<h:panelGrid id="searchParams" columns="11" focus="fam" class="invis search-panel--str">
				<p:outputLabel for="fam" value="Фамилия" />
				<p:inputText id="fam" value="#{listmanBean.srcFam}" />
				<p:outputLabel for="im" value="Имя" />
				<p:inputText id="im" value="#{listmanBean.srcIm}" />
				<p:outputLabel for="ot" value="Отчество" />
				<p:inputText id="ot" value="#{listmanBean.srcOt}" />
				<p:outputLabel for="dr" value="Дата рождения" />
				<p:calendar id="dr" value="#{listmanBean.srcDr}" locale="#{applicationBean.locale.language}" pattern="#{applicationBean.dateFormat.toPattern()}" />
				<p:outputPanel></p:outputPanel>
				<p:commandButton id="search" value="Найти" action="#{listmanBean.search()}" update="patientTable msg-search" onsuccess="PF('wv').getPaginator().setPage(0)" class="button-volume button-volume--mini " icon="ui-icon-search" >
				</p:commandButton>
			    <p:commandButton id="btn-showall" value="Показать всех" action="#{listmanBean.clearSearch()}" update="searchParams patientTable msg-search" onsuccess="PF('wv').getPaginator().setPage(0)" class="button-volume button-volume--mini" icon="ui-icon-all"/>
			</h:panelGrid>
		  </p:outputPanel>
		  </div>
		  
		  
		  <p:outputPanel rendered="true" class="blok-button--above--right">	
		    <p:messages id="msg-search" autoUpdate="false"/>
    	      <p:commandLink update=":frmFind:pnlDlg" oncomplete="PF('find').show()" class="button-link button-link--blue">
				<p:outputPanel class="ui-icon ui-icon-filter"/>
				<h:outputText id="btn-filter" value="Фильтр записей"/>
		      </p:commandLink>
		  </p:outputPanel>
		  
		  <p:outputPanel class="main clearfix"> 
			<p:dataTable id="patientTable" value="#{listmanBean.model}" var="v"
				widgetVar="wv"
				paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
				first="#{listmanBean.paginatorFirst}"
				paginator="true" rows="#{listmanBean.paginatorRowsCount}" lazy="true"				
				rowsPerPageTemplate="5, 10, 15"
				paginatorPosition="bottom"
				rowStyleClass="#{v.datDeath != null ? 'patient-death--table' : 'patient-living--table'}"				
				class="my-table my-table--auto patient__table patient__table--str" emptyMessage="#{msg['PatList.Empty']}">
				<p:ajax event="page" listener="#{listmanBean.onPageChange}" />
				<p:column headerText="Информация о пациенте">				   
				    <p:link id="view" class="ui-icon ui-icon-open" outcome="viewman">					        
						<f:param name="patId" value="#{v.id}"/>
						<f:param name="editable" value="false"/>
				    </p:link>
				    <p:tooltip for="view" value="Просмотр" class="my-tooltip"/>
				   
				    <p:link id="edit" class="ui-icon ui-icon-Editor" outcome="editman">					        
						<f:param name="patId" value="#{v.id}"/>
						<f:param name="editable" value="true"/>
				    </p:link>
				    <p:tooltip for="edit" value="Редактирование" class="my-tooltip"/>
				</p:column>
								
				<p:column headerText="Фамилия">
					<h:outputText value="#{v.lastName}" />
				</p:column>
				
				<p:column headerText="Имя">
					<h:outputText value="#{v.firstName}" />
				</p:column>

				<p:column headerText="Отчество">
					<h:outputText value="#{v.fatherName}" />
				</p:column>
				<p:column headerText="Дата рождения">
					<h:outputText value="#{v.datBirth}">
					  <f:convertDateTime locale="#{applicationBean.locale.language}" />
					</h:outputText>
				</p:column>

				<p:column headerText="Пол" rendered="false">
					<h:outputText value="#{v.gender}" />
				</p:column>

				<p:column headerText="Населенный пункт" >
					<h:outputText value="#{v.address.livCity}"/>
				</p:column>		
				

				<p:column headerText="Адрес" rendered="false">
					<h:outputText value="#{v.address.livStreet} #{v.address.livHouse} - #{v.address.livFlat}" />
				</p:column>

				<p:column headerText="Дата последнего обследования">
					<p:commandLink id="data-exam" update=":browseExamId" oncomplete="PF('browseExamVar').show()" actionListener="#{listmanBean.setSelectedFIO(v.lastName, v.firstName, v.fatherName)}" action="#{examinationBean.loadExam(v.id, v.patientId, false)}" class="#{examinationBean.NotSurveyed(v) ? 'link-only--red' : 'link-only'}">
						<h:outputText value="#{v.lastExam}">
							<f:convertDateTime locale="#{applicationBean.locale.language}" />
						</h:outputText>
					</p:commandLink>
					<p:tooltip for="data-exam" value="Просмотр исследований" class="my-tooltip"/>
				</p:column>

				<p:column headerText="Результат">
					<h:outputText value="#{v.result}" />
				</p:column>

				<p:column headerText="Верификация">
					<h:outputText value="#{v.verification}" />
				</p:column>
				
				<p:column headerText="Дата смерти" rendered="false">
					<h:outputText value="#{v.datDeath}" />
				</p:column>
				
			</p:dataTable>	
		

		    </p:outputPanel>
  </p:outputPanel>
  
	  <p:outputPanel class="footer">
		      <p:outputPanel class="blok-button--within--down">		
				 							
				<p:link outcome="editman" class="button-volume button-volume--link">
				    <p:outputPanel class="ui-icon ui-icon-User-Add"/>
					<f:param name="editable" value="true"/>
					<h:outputText value="Добавить пациента"/>											     
				</p:link>
				
				<p:commandLink id="btn-report" update=":frmPrint:pnlDlg" oncomplete="PF('print').show()" class="button-volume button-volume--link margin-left--big" >
					<p:outputPanel class="ui-icon ui-icon-reports"/>
					<h:outputText value="Отчетные формы"/>
				</p:commandLink>
				
				<p:link outcome="upload" class="button-volume button-volume--link margin-left--big" >
					<p:outputPanel class="ui-icon ui-icon ui-icon-xls"/>
					<h:outputText value="Загрузить из файла"/>
				</p:link>
				
				<p:link outcome="planman" class="button-volume button-volume--link margin-left--big">
				    <p:outputPanel class="ui-icon ui-icon-plan"/>
					<f:param name="editable" value="true"/>
					<h:outputText value="Редактировать план на год"/>											     
				</p:link>				
				
		      </p:outputPanel>
	  </p:outputPanel>		      
    </h:form>
  				
	<p:dialog id="browseExamId" widgetVar="browseExamVar" modal="true" header="Пациент: #{listmanBean.selectedFIO}" resizable="false" class="my-overlay my-overlay--scroll">
	  <div class="button--close-dialog">
	  <p:commandButton id="btn-closeexamid" value="Закрыть" oncomplete="PF('browseExamVar').hide()" icon="ui-icon-close" class="button-link button-link--white"/> 
	  </div>
	  <ui:include src="WEB-INF/templates/examination.xhtml"/>
	</p:dialog>

    <h:form id="frmFind" >
		<p:dialog id="dlg" widgetVar="find" modal="true" header="Фильтр записей" resizable="false" class="my-overlay my-overlay--scroll filtr--str">			
		<div class="button--close-dialog">
		  <p:commandButton id="btn-filterclose" value="Закрыть" oncomplete="PF('find').hide()" icon="ui-icon-close" class="button-link button-link--white"/>
		</div>    
			<p:outputPanel id="pnlDlg" class="move-up">
			  <p:scrollPanel mode="native" style="max-height: 600px">				
			    <p:panel header="Адрес проживания" class="blok-overlay">
			      <p:outputPanel style="padding-left: 40px">
					<cc:fias_addr  managedBean="#{fiasEditorFilter}"/>
			      </p:outputPanel>	
			    </p:panel>
			
			    <p:panel header="МО прикрепления пациентa по ОМС" class="blok-overlay">				
					<cc:medical_org managedBean="#{filterBean}" />
			    </p:panel>
			    <p:panel header="Контингенты населения" class="blok-overlay">					
					<cc:patient_groups managedBean="#{filterBean}" decrGroupValue="#{filterBean.selectedDg}" 
						medGroupValue="#{filterBean.selectedMg}" riskGroupValue="#{filterBean.selectedSg}"/>
			    </p:panel>
			    <p:panel header="Обследования" class="blok-overlay">					
				<h:panelGrid columns="2" class="invis">
			        <p:outputLabel for="regobs" value="Регион" />
				    <p:selectOneMenu id="regobs" value="#{filterBean.selectedRegObs}" converter="#{filterBean.mor2Converter}" class="my-select" style="#{filterBean.moRegionObsList.size() == 0 ?'color:#d7d7d7;' : 'color:#00000;'}">
						<p:ajax listener="#{filterBean.regobsSelected}" update="npobs mobs" />
						<f:selectItem itemLabel="#{filterBean.moRegionObsList.size() == 0 ? '-- Список пуст --' : '-- Ничего не выбрано --'}" itemValue="#{null}" noSelectionOption="true" />
						<f:selectItems value="#{filterBean.moRegionObsList}" var="r" itemLabel="#{r.regId} - #{r.name}" itemValue="#{r}" />
				     </p:selectOneMenu>

			        <p:outputLabel for="npobs" value="Населенный пункт" />
				  <p:selectOneMenu id="npobs" value="#{filterBean.selectedTerObs}" converter="#{filterBean.mot2Converter}" class="my-select" style="#{filterBean.moTerList2.size() == 0 ?'color:#d7d7d7;' : 'color:#00000;'}">
				      <p:ajax listener="#{filterBean.motobsSelected}" update="mobs" />
			          <f:selectItem itemLabel="#{filterBean.moTerList2.size() == 0 ? '-- Список пуст --' : '-- Ничего не выбрано --'}" itemValue="#{null}" noSelectionOption="true" />
				      <f:selectItems value="#{filterBean.moTerList2}" var="r" itemLabel="#{r.id.terId} - #{r.name}" itemValue="#{r}" />
				    </p:selectOneMenu>
				    
			        <p:outputLabel for="mobs" value="ЛПУ" />
				  <p:selectOneMenu id="mobs" value="#{filterBean.selectedLpuObs}" converter="#{filterBean.mom2Converter}" class="my-select" style="#{filterBean.moMainList2.size() == 0 ?'color:#d7d7d7;' : 'color:#00000;'}">
			          <f:selectItem itemLabel="#{filterBean.moMainList2.size() == 0 ? '-- Список пуст --' : '-- Ничего не выбрано --'}" itemValue="#{null}" noSelectionOption="true" />
				      <f:selectItems value="#{filterBean.moMainList2}" var="r" itemLabel="#{r.id.lpuId} - #{r.name}" itemValue="#{r}" />
				    </p:selectOneMenu>
	    
			        <h:outputLabel for="rez" value="Результат" />
				   <p:selectOneMenu id="rez" value="#{filterBean.selectedRezType}"  converter="#{filterBean.restypeConverter}" class="my-select" style="#{filterBean.restypeList.size() == 0 ?'color:#d7d7d7;' : 'color:#00000;'}">
			          <f:selectItem itemLabel="#{filterBean.restypeList.size() == 0 ? '-- Список пуст --' : '-- Ничего не выбрано --'}" itemValue="#{null}" noSelectionOption="true" />
				      <f:selectItems value="#{filterBean.restypeList}" var="r" itemLabel="#{r.id} - #{r.name}" itemValue="#{r}" />
				    </p:selectOneMenu>

					<p:outputLabel for="ver" value="Верификация" />
				    <p:selectOneMenu id="ver" value="#{filterBean.selectedVer}" converter="#{filterBean.verConverter}" class="my-select">
			          <f:selectItem itemLabel="#{filterBean.verList.size() == 0 ? '-- Список пуст --' : '-- Ничего не выбрано --'}" itemValue="#{null}" noSelectionOption="true" />
				      <f:selectItems value="#{filterBean.verList}" var="r" itemLabel="#{r.id} - #{r.name}" itemValue="#{r}" />
				    </p:selectOneMenu>
					
					<p:column>
			   			<p:outputLabel value="Период: c " />
					</p:column>
					<p:column>						    
					    <p:calendar id="dn" value="#{filterBean.datStart}" locale="ru" class="data" />
					    <p:outputLabel value="&#160;&#160; по &#160;" />
					    <p:calendar id="dk" value="#{filterBean.datEnd}" locale="ru" class="data" />
					</p:column>						
				</h:panelGrid>
			    </p:panel > 
			  </p:scrollPanel>
			  		<p:outputPanel rendered="true" class="blok-button--within--down" >
			    	<p:messages id="msg-filter" autoUpdate="false"/>
					<p:commandButton id="btn-confirmfilter" value="Применить" action="#{listmanBean.filter()}" update=":frmList:patientTable msg-filter" oncomplete="if (args &amp;&amp; !args.validationFailed) PF('find').hide()" onsuccess="PF('wv').getPaginator().setPage(0)" class="button-volume button-volume--mini" icon="ui-icon-save">
					</p:commandButton>
					<p:commandButton id="filter-clear" value="Очистить поля" action="#{filterBean.clearFilter()}" update=":frmFind:pnlDlg" class="button-volume button-volume--mini margin-left--big" icon="ui-icon-clear">
			       		<p:ajax resetValues="true" update=":frmFind:pnlDlg" />
					</p:commandButton>
					<p:outputLabel rendered="#{!filterBean.filterClear}" value="Фильтр не был очищен "/>
			    </p:outputPanel>
		      </p:outputPanel>			   	
		</p:dialog>

	</h:form>

  	<h:form id="frmException" >
	    <p:ajaxExceptionHandler type="java.lang.Exception"
                            update="exceptionDialog"
                            onexception="PF('exceptionDialog').show();" />
 
	    <p:dialog id="exceptionDialog" header="Ошибка" widgetVar="exceptionDialog"
	              height="100px" class="my-overlay filtr--str">
		  	<p:commandButton id="btn-closeexeption" value="Закрыть" oncomplete="PF('exceptionDialog').hide()" icon="ui-icon-close" class="button-link button-link--white"/>
	        <br/><br/>Сообщение: #{pfExceptionHandler.message} <br/>
	    </p:dialog>
	</h:form>
             
	<h:form id="frmPrint">
		<p:dialog id="dlg" widgetVar="print" modal="true"
			header="Отчетные формы" resizable="false" class="my-overlay">
			<div class="button--close-dialog">
			<p:commandButton id="btn-closereport" value="Закрыть" oncomplete="PF('print').hide()" icon="ui-icon-close" class="button-link button-link--white"/>
			</div>
			<p:outputPanel id="pnlDlg" class="move-up report--str" >				  
			  <p:panel header="Уровень отчета" class="blok-overlay">				
				<cc:medical_org managedBean="#{reportBean}" renderedPoliclinic="false" />
			  </p:panel>
			  <p:panel header="Период" class="blok-overlay">
				<h:panelGrid columns="2" class="invis report-uroven--str">
				    <p:column>
				        <p:outputLabel value="Сформировать отчет: с" />  
				    </p:column>
				    <p:column>						
					<p:calendar id="dn" value="#{reportBean.datStart}" locale="ru" class="data"/>
					<p:outputLabel value="&#160; &#160; по " />
					<p:calendar id="dk" value="#{reportBean.datEnd}" locale="ru" class="data"/>
				    </p:column>
				</h:panelGrid>
			   </p:panel>
			  <p:panel header="Вид отчета" class="blok-overlay">
			    <p:messages id="msg-rep" autoUpdate="false"/>
				<h:panelGrid columns="3" class="invis vid-reports--str">
					<p:outputLabel value="1. Флюороосмотры социальных групп населения" />
					
					<p:outputPanel class="button-link button-link--blue"> 
					<p:commandLink class="ui-icon ui-icon-paper" action="#{reportBean.printReport(1, false)}" />
					<p:commandLink id="btn-showsoc" value="Показать на экране" update="msg-rep" action="#{reportBean.printReport(1, false)}" />
					</p:outputPanel>
					
					<p:outputPanel class="button-link button-link--blue"> 
					<p:commandLink class="ui-icon ui-icon-pdf" action="#{reportBean.printReport(1, true)}" />
					<p:commandLink id="btn-pdfsoc" value="Сформировать в PDF" update="msg-rep" action="#{reportBean.printReport(1, true)}" />
					</p:outputPanel>
					
					<p:outputLabel value="2. Флюороосмотры декретированных групп населения" />
					
					<p:outputPanel class="button-link button-link--blue"> 
					<p:commandLink class="ui-icon ui-icon-paper" action="#{reportBean.printReport(3, false)}" />						
					<p:commandLink id="btn-showdec" value="Показать на экране" update="msg-rep" action="#{reportBean.printReport(3, false)}" />
					</p:outputPanel>
					
					<p:outputPanel class="button-link button-link--blue"> 
					<p:commandLink class="ui-icon ui-icon-pdf" action="#{reportBean.printReport(3, true)}" />
					<p:commandLink id="btn-pdfdec" value="Сформировать в PDF" update="msg-rep" action="#{reportBean.printReport(3, true)}" />
					</p:outputPanel>

					<p:outputLabel value="3. Флюороосмотры медицинских групп населения" />
					
					<p:outputPanel class="button-link button-link--blue">
					<p:commandLink class="ui-icon ui-icon-paper" action="#{reportBean.printReport(2, false)}" />  
					<p:commandLink id="btn-showmed" value="Показать на экране" update="msg-rep" action="#{reportBean.printReport(2, false)}" />
					</p:outputPanel>
					
					<p:outputPanel class="button-link button-link--blue"> 
					<p:commandLink class="ui-icon ui-icon-pdf" action="#{reportBean.printReport(2, true)}" />
					<p:commandLink id="btn-pdfmed" value="Сформировать в PDF" update="msg-rep" action="#{reportBean.printReport(2, true)}" />
					</p:outputPanel>
					
				</h:panelGrid>
			  </p:panel>
			</p:outputPanel>
		</p:dialog>
	</h:form>	
</h:body>

</html>
